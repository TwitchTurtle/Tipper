<html>
<body>

<input id="name" name="textinput" type="text" value="" placeholder="Name" required="">
<textarea id="message" style="overflow: hidden;margin-top: 5.5px;margin-bottom: 0px;height: 36px;width: 51%;font-size: 11px;" placeholder="Your Message"></textarea>
<button onclick="submit()" title="Donate!">Donate!</button>
<p id="result">Result</p>
<div id="qr_address" class="qr_address"></div>


<script src="qrcode.js"></script>
<script src="cryptonote.min.js"></script>

<script>
  function createIntegratedAddress(address, paymentid) {
  var prefix = 3914525
  try {
    var addr = CryptoNote.decode_address(address, prefix)
    if (!addr) return false
    
    return CryptoNote.encode_address(addr.publicViewKey, addr.publicSpendKey, prefix, paymentid)
  } catch (e) {
    return false
  }
}
  function ascii_to_hexa(str)
    {
  	var arr1 = [];
  	for (var n = 0, l = str.length; n < l; n ++)
       {
  		var hex = Number(str.charCodeAt(n)).toString(16);
  		arr1.push(hex);
  	 }
  	return arr1.join('');
  }
  function submit() {
    var name = document.getElementById("name").value;
    var message = document.getElementById("message").value;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "https://api.twitchturtle.com/address/" + window.location.pathname.replace("/", ""), false );
    xmlHttp.setRequestHeader('Content-Type', 'application/json');
    xmlHttp.send( null );
    resp = JSON.parse(xmlHttp.responseText);
    
    var intAddr = createIntegratedAddress(resp.address, JSON.parse(this.responseText).paymentID);

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "https://api.twitchturtle.com/tipper", true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({
        extra: ascii_to_hexa('{"name":"' + name + '","message":"' + message + '"}')
    }));
    xhr.onload = function() {
          document.getElementById("result").innerHTML = "Send your TRTL to " + intAddr;
          var typeNumber = 0;
          var errorCorrectionLevel = 'L';
          var qr = qrcode(typeNumber, errorCorrectionLevel);
          qr.addData(intAddr);
          qr.make();
          document.getElementById('qr_address').innerHTML = qr.createImgTag();
    }
  }
</script>
</body>
