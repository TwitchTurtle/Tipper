<html>
<body style="background-color: #f5f5f5;">
<div id="userImg" style="width: 100%;height: 200px;margin-right: auto;background: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.25)), url(https://static-cdn.jtvnw.net/jtv_user_pictures/df57f76ae9527319-profile_banner-480.png) center center / cover no-repeat;" https:="" static-cdn.jtvnw.net="" jtv_user_pictures="">
	<a id="userName" style="color: #fff;position: absolute;top: 150px;left: 30px;">Name</a>
	<a id="userLink" style="color: #fff;position: absolute;top: 150px;right: 30px;">twitch.tv/blah</a>
</div>
<div style="width: 80%;text-align: center;margin: auto;display: block;">
  <img id="userLogo" style="height: 128px;display: block;margin: auto;" />
  <br><br>
  <input id="name" name="textinput" type="text" value="" placeholder="Name" required="">
  <br>
  <textarea id="message" style="overflow: hidden;margin-top: 5.5px;margin-bottom: 0px;height: 36px;width: 51%;font-size: 11px;" placeholder="Your Message"></textarea>
  <br>
  <button onclick="submit()" title="Donate!">Donate!</button>
  <p id="result">Result</p>
  <div id="qr_address" class="qr_address"></div>
</div>
<script src="/qrcode.js"></script>
<script src="/cryptonote.min.js"></script>

<script>
function createIntegratedAddress(address, paymentid) {
  var prefix = 3914525
  try {
    var addr = CryptoNote.decode_address(address, prefix)
    if (!addr) return false
    
    return CryptoNote.encode_address(addr.publicViewKey, addr.publicSpendKey, prefix, paymentid)
  } catch (e) {
    return false
  }
}

function ascii_to_hexa(str) {
  	var arr1 = [];
  	for (var n = 0, l = str.length; n < l; n ++)
       {
  		var hex = Number(str.charCodeAt(n)).toString(16);
  		arr1.push(hex);
  	 }
  	return arr1.join('');
}

function submit() {
    var name = document.getElementById("name").value;
    var message = document.getElementById("message").value;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "https://api.twitchturtle.com/address/" + window.location.pathname.replace(/\//ig, ""), false );
    xmlHttp.setRequestHeader('Content-Type', 'application/json');
    xmlHttp.send( null );
    resp = JSON.parse(xmlHttp.responseText);
    
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "https://api.twitchturtle.com/tipper", true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({
      extra: ascii_to_hexa('{"name":"' + name + '","message":"' + message + '"}')
    }));
    xhr.onload = function() {
          var intAddr = createIntegratedAddress(resp.address, JSON.parse(this.responseText).paymentID);
          document.getElementById("result").innerHTML = "Send your TRTL to " + intAddr;
          var typeNumber = 0;
          var errorCorrectionLevel = 'L';
          var qr = qrcode(typeNumber, errorCorrectionLevel);
          qr.addData(intAddr);
          qr.make();
          document.getElementById('qr_address').innerHTML = qr.createImgTag();
          swal("Send your TRTLs here!", intAddr + "<br><br>" + qr.createImgTag())
    }
}
window.onload = function(){ 
    var username = window.location.pathname.replace(/\//ig, "");
    document.title = username + "'s TwitchTurtle donation page.";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "https://api.twitch.tv/kraken/channels/" + username + "?client_id=rgkaxvgg18t24iqtys37zqa6s9r9sb", true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send();
    xhr.onload = function() {
	var res = JSON.parse(this.response);
      	document.getElementById("userLogo").src = (res.logo);
	document.getElementById("userImg").style.backgroundImage = "linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.25)), url('" + (res.profile_banner) + "')";
	document.getElementById("userName").innerHTML = username
	document.getElementById("userLink").innerHTML = "https://twitch.tv/" + username;
	document.getElementById("userLink").href = "https://twitch.tv/" + username;
    }
}
</script>
<script src="/sweetalert2.all.min.js"></script>
</body>
